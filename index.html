<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="theme-color" content="#0b1220" />
  <title>Ù„Ø¹Ø¨Ø© Ø³Ø¨Ø§ÙŠØ¯Ø±Ù…Ø§Ù† Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</title>

  <link rel="manifest" href="manifest.json" />
  <style>
    :root{
      --bg:#0b1220;
      --panel:rgba(255,255,255,.08);
      --panel2:rgba(255,255,255,.12);
      --txt:#ffffff;
      --muted:rgba(255,255,255,.7);
      --accent:#ff3b30;
      --ok:#34c759;
      --warn:#ffcc00;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --font: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html, body{width:100%;height:100%;}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 60% -10%, rgba(120,160,255,.22), transparent 60%),
                  radial-gradient(900px 600px at 20% 110%, rgba(255,120,120,.14), transparent 60%),
                  var(--bg);
      color:var(--txt);
      font-family:var(--font);
      overflow:hidden;
      touch-action: none;
    }
    .wrap{
  position:fixed;
  inset:0;
  width:100%;
  height:100dvh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:12px;
}
    .card{
  width: min(900px, calc(100vw - 24px));
  max-width: 100%;
  height: min(980px, calc(100dvh - 24px));
  margin: 0 auto;
  background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
  border:1px solid rgba(255,255,255,.12);
  border-radius:16px;
  box-shadow:var(--shadow);
  overflow:hidden;
  display:flex;
  flex-direction:column;
}
    .topbar{flex:0 0 auto;

      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:12px 14px;
      background:rgba(0,0,0,.25);
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .brand{
      display:flex; gap:10px; align-items:center;
      font-weight:700;
      letter-spacing:.2px;
    }
    .pill{
      font-size:12px; color:var(--muted);
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.12);
      padding:6px 10px; border-radius:999px;
      white-space:nowrap;
    }
    .hud{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      justify-content:flex-start;
    }
    .hud b{font-variant-numeric: tabular-nums}
    .main{
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .stage{
      position:relative;
      width:100%;
      flex:1 1 auto;
      min-height:0;
      background: rgba(0,0,0,.08);
    }
    canvas{
      width:100%; height:100%;
      display:block;
      background: transparent;
    }

    /* Screens / overlays */
    .overlay{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      padding:14px;
    }
    .panel{
      width:min(520px, 100%);
      background:linear-gradient(180deg, rgba(255,255,255,.13), rgba(255,255,255,.07));
      border:1px solid rgba(255,255,255,.14);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .panel h1, .panel h2{margin:0 0 10px 0}
    .panel p{margin:8px 0; color:var(--muted); line-height:1.7}
    .row{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    input[type="text"]{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      color:var(--txt);
      outline:none;
      font-size:16px;
    }
    .btn{
      appearance:none; border:0;
      padding:12px 14px;
      border-radius:14px;
      background:rgba(255,255,255,.14);
      color:var(--txt);
      border:1px solid rgba(255,255,255,.16);
      font-weight:700;
      cursor:pointer;
      transition:.15s transform ease, .15s background ease;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); background:rgba(255,255,255,.18)}
    .btn.primary{
      background:rgba(52,199,89,.22);
      border-color:rgba(52,199,89,.35);
    }
    .btn.danger{
      background:rgba(255,59,48,.20);
      border-color:rgba(255,59,48,.35);
    }
    .btn.wide{width:100%}

    /* Question UI */
    .qbox{
      margin-top:10px;
      border-radius:16px;
      padding:12px;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.12);
    }
    .qtitle{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .timer{
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,204,0,.18);
      border:1px solid rgba(255,204,0,.35);
      color:#fff;
      font-weight:800;
      font-variant-numeric: tabular-nums;
    }
    .choices{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    .choice{
      padding:12px;
      border-radius:14px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      cursor:pointer;
      font-weight:800;
      text-align:center;
      user-select:none;
    }
    .choice:hover{background:rgba(255,255,255,.14)}
    .note{
      font-size:12px; color:var(--muted);
      margin-top:10px;
    }


    /* ØªÙ…Ø«ÙŠÙ„ Ø¨ØµØ±ÙŠ Ù„Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ */
    .visual{
      margin-top:10px;
      padding:10px;
      border-radius:14px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
    }
    .visualRow{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:flex-start;
    }
    .vLabel{
      min-width: 72px;
      color: rgba(255,255,255,.85);
      font-weight:800;
      margin-inline-end:6px;
    }
    .token{
      width:20px; height:20px;
      border-radius:999px;
      background:rgba(255,255,255,.88);
      box-shadow: 0 2px 6px rgba(0,0,0,.25);
      position:relative;
      flex: 0 0 auto;
    }
    .token.dim{background:rgba(255,255,255,.55)}
    .token.cross::after{
      content:"";
      position:absolute;
      inset: 2px;
      border-radius:999px;
      background: transparent;
      border:2px solid rgba(255,255,255,.20);
    }
    .token.cross::before{
      content:"";
      position:absolute;
      left:3px; right:3px;
      top:50%;
      height:2px;
      background: rgba(255,59,48,.78);
      transform: rotate(-18deg);
      box-shadow: 0 0 0 1px rgba(0,0,0,.10);
    }
    .visualHint{
      margin-top:8px;
      color: rgba(255,255,255,.72);
      font-size:12px;
      line-height:1.6;
    }

    /* Footer */
    footer{flex:0 0 auto;

      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      color:rgba(255,255,255,.8);
      flex-wrap:wrap;
    }
    .social{
      display:flex; gap:10px; align-items:center;
    }
    .iconbtn{
      width:36px; height:36px;
      border-radius:12px;
      display:inline-flex; align-items:center; justify-content:center;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      color:#fff;
      text-decoration:none;
    }
    .iconbtn:hover{background:rgba(255,255,255,.14)}
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      padding:2px 6px;
      border-radius:8px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.12);
      color:#fff;
    }

    @media (max-width: 520px){
      .choices{grid-template-columns: 1fr}
      .wrap{
  position:fixed;
  inset:0;
  width:100%;
  height:100dvh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:12px;
}
      .card{
  width: min(900px, calc(100vw - 24px));
  max-width: 100%;
  height: min(980px, calc(100dvh - 24px));
  margin: 0 auto;
  background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
  border:1px solid rgba(255,255,255,.12);
  border-radius:16px;
  box-shadow:var(--shadow);
  overflow:hidden;
  display:flex;
  flex-direction:column;
}
      .topbar{gap:8px}
      .brand{gap:8px}
      footer{padding:10px 12px}
    }
      .topbar{gap:8px}
      .brand{gap:8px}
      footer{padding:10px 12px}
    }
      .wrap{
  position:fixed;
  inset:0;
  width:100%;
  height:100dvh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:12px;
}
      .card{
  width: min(900px, calc(100vw - 24px));
  max-width: 100%;
  height: min(980px, calc(100dvh - 24px));
  margin: 0 auto;
  background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
  border:1px solid rgba(255,255,255,.12);
  border-radius:16px;
  box-shadow:var(--shadow);
  overflow:hidden;
  display:flex;
  flex-direction:column;
}
      .stage{
        height: auto;
      }
      canvas{touch-action:none}
    }
  
    html, body { height:100%; }
    .card{
  width: min(900px, calc(100vw - 24px));
  max-width: 100%;
  height: min(980px, calc(100dvh - 24px));
  margin: 0 auto;
  background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
  border:1px solid rgba(255,255,255,.12);
  border-radius:16px;
  box-shadow:var(--shadow);
  overflow:hidden;
  display:flex;
  flex-direction:column;
}
    @media (max-width: 520px){
      .choices{grid-template-columns: 1fr}
      .wrap{
  position:fixed;
  inset:0;
  width:100%;
  height:100dvh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:12px;
}
      .card{
  width: min(900px, calc(100vw - 24px));
  max-width: 100%;
  height: min(980px, calc(100dvh - 24px));
  margin: 0 auto;
  background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
  border:1px solid rgba(255,255,255,.12);
  border-radius:16px;
  box-shadow:var(--shadow);
  overflow:hidden;
  display:flex;
  flex-direction:column;
}
      .topbar{gap:8px}
      .brand{gap:8px}
      footer{padding:10px 12px}
    }
      .topbar{gap:8px}
      .brand{gap:8px}
      footer{padding:10px 12px}
    }
      .card{
  width: min(900px, calc(100vw - 24px));
  max-width: 100%;
  height: min(980px, calc(100dvh - 24px));
  margin: 0 auto;
  background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
  border:1px solid rgba(255,255,255,.12);
  border-radius:16px;
  box-shadow:var(--shadow);
  overflow:hidden;
  display:flex;
  flex-direction:column;
}
      .topbar{flex:0 0 auto;
 padding:10px 12px; }
      footer{flex:0 0 auto;
 padding:10px 12px; }
      .stage{
        height: calc(100vh - 54px - 60px);
        min-height: 520px;
      }
    }

  </style>
</head>
<body>

<div class="wrap">
  <div class="card">
    <div class="topbar">
      <div class="brand">
        ğŸ•·ï¸ <span>Ø³Ø¨Ø§ÙŠØ¯Ø±Ù…Ø§Ù† ÙŠÙ‚ÙØ² Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡</span>
        </div>
      <div class="hud">
        <span class="pill">Ø§Ù„Ù„Ø§Ø¹Ø¨: <b id="hudName">â€”</b></span>
        <span class="pill">Ø§Ù„Ù…Ø±Ø­Ù„Ø©: <b id="hudLevel">Ù </b></span>
        <span class="pill">Ø§Ù„Ù†Ù‚Ø§Ø·: <b id="hudScore">Ù </b></span>
        <span class="pill">Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„: <b id="hudHits">Ù </b>/Ù¢</span>
      </div>
    </div>

    <div class="main">
      <div class="stage">
        <canvas id="c" width="1280" height="720" aria-label="Ù„Ø¹Ø¨Ø© Ø³Ø¨Ø§ÙŠØ¯Ø±Ù…Ø§Ù†"></canvas>

        <!-- Start screen -->
        <div class="overlay" id="startOverlay">
          <div class="panel">
            <h1>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨</h1>
            <p>Ø§ÙƒØªØ¨ Ø§Ø³Ù…ÙƒØŒ Ø«Ù… Ø§Ø¨Ø¯Ø£. Ø§Ù„ØªØ­ÙƒÙ…: Ù„Ù…Ø³ Ø§Ù„Ø´Ø§Ø´Ø© Ø£Ùˆ Ø²Ø± <span class="kbd">Ù…Ø³Ø§ÙØ©</span> Ù„Ù„Ù‚ÙØ².</p>
            <div class="row" style="margin-top:10px">
              <input id="nameInput" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù‡Ù†Ø§" maxlength="20" />
            </div>
            <div class="row" style="margin-top:12px">
              <button class="btn primary wide" id="btnStart">Ø¨Ø¯Ø¡</button>
            </div>
            <p class="note">ÙÙƒØ±Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©: Ø¥Ø°Ø§ Ù†Ø²Ù„ Ø³Ø¨Ø§ÙŠØ¯Ø±Ù…Ø§Ù† ÙÙˆÙ‚ Ø§Ù„Ø¹Ø¯Ùˆ ÙŠÙ…ÙˆØª Ø§Ù„Ø¹Ø¯Ùˆ. Ø¥Ø°Ø§ Ø§ØµØ·Ø¯Ù… Ø¨Ù‡ Ù‚Ø¨Ù„ Ø§Ù„Ù‚ÙØ²: ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ ÙØ±ØµØ© (ÙŠØµØ¨Ø­ Ø´ÙØ§ÙÙ‹Ø§ Ù‚Ù„ÙŠÙ„Ø§Ù‹)ØŒ ÙˆØ¥Ø°Ø§ ØªÙƒØ±Ø± Ø§Ù„Ø§ØµØ·Ø¯Ø§Ù… ÙŠØ¸Ù‡Ø± Ø³Ø¤Ø§Ù„ Ù„Ù…Ø¯Ø© Ù£Ù  Ø«Ø§Ù†ÙŠØ©.</p>
          </div>
        </div>

        <!-- Question overlay -->
        <div class="overlay" id="qOverlay" style="display:none">
          <div class="panel">
            <h2>Ø³Ø¤Ø§Ù„ Ø³Ø±ÙŠØ¹</h2>
            <div class="qbox">
              <div class="qtitle">
                <div id="qText" style="font-weight:900;font-size:18px"></div>
                <div class="timer">â± <span id="qTimer">Ù£Ù </span> Ø«Ø§Ù†ÙŠØ©</div>
              </div>
              <div class="visual" id="qVisual"></div>
              <div class="choices" id="qChoices"></div>
              <div class="note" id="qNote">Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‚Ø¨Ù„ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª.</div>
            </div>
            <div class="row" style="margin-top:12px">
              <button class="btn danger wide" id="btnRestart">Ø¥Ø¹Ø§Ø¯Ø© Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</button>
            </div>
          </div>
        </div>

        <!-- Pause / info overlay -->
        <div class="overlay" id="msgOverlay" style="display:none">
          <div class="panel">
            <h2 id="msgTitle">â€”</h2>
            <p id="msgBody">â€”</p>
            <div class="row" style="margin-top:12px">
              <button class="btn primary wide" id="btnContinue">Ù…ØªØ§Ø¨Ø¹Ø©</button>
            </div>
          </div>
        </div>

      </div>

      <footer>
        <div>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù€ <b>Ø³Ù„Ù…Ø§Ù† Ø§Ù„Ø¬Ù†ÙŠØ¯ÙŠ</b></div>
        <div class="social">
          <a class="iconbtn" href="https://snapchat.com/t/4O2IhALH" target="_blank" rel="noopener" aria-label="Snapchat">
            <!-- Snapchat icon (simple) -->
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M12 3c2.7 0 5 2 5 4.7v3.4c.8.5 1.7.6 2.3 1.2.5.5.2 1.2-.4 1.4-.6.2-1.2.3-1.6.8-.4.6.6 2 2.4 2.4.6.1.7 1 .2 1.3-1.2.7-2.5.9-3.2 1.6-.5.5-.5 1.4-1.1 1.7-1 .5-2.3.4-2.6 1.1-.2.4-.6.7-1 .7s-.8-.3-1-.7c-.3-.7-1.6-.6-2.6-1.1-.6-.3-.6-1.2-1.1-1.7-.7-.7-2-.9-3.2-1.6-.5-.3-.4-1.2.2-1.3 1.8-.4 2.8-1.8 2.4-2.4-.4-.5-1-.6-1.6-.8-.6-.2-.9-.9-.4-1.4.6-.6 1.5-.7 2.3-1.2V7.7C7 5 9.3 3 12 3Z" stroke="white" stroke-width="1.6" opacity=".95"/>
            </svg>
          </a>
          <a class="iconbtn" href="https://wa.me/966566996166" target="_blank" rel="noopener" aria-label="WhatsApp">
            <!-- WhatsApp icon (simple) -->
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M20 12a8 8 0 0 1-11.7 7L4 20l1.1-4.1A8 8 0 1 1 20 12Z" stroke="white" stroke-width="1.6" opacity=".95"/>
              <path d="M9.2 8.9c.2-.4.4-.4.7-.4h.6c.2 0 .4.1.5.4l.7 1.8c.1.2.1.4 0 .6l-.4.6c-.1.2-.1.4.1.6.5.7 1.2 1.3 2 1.7.2.1.4.1.6-.1l.6-.4c.2-.1.4-.1.6 0l1.8.7c.3.1.4.3.4.5v.6c0 .3 0 .5-.4.7-.5.4-1.6.8-2.7.5-2.6-.7-4.7-2.8-5.5-5.5-.3-1.1.1-2.2.5-2.7Z" fill="white" opacity=".9"/>
            </svg>
          </a>
        </div>
      </footer>
    </div>
  </div>
</div>

<script>
/* =========================
   Ø£Ø¯ÙˆØ§Øª Ø¹Ø±Ø¨ÙŠØ© Ù„Ù„Ø£Ø±Ù‚Ø§Ù…
========================= */
const toArabicDigits = (n) => String(n).replace(/[0-9]/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"[d]);
const clamp = (v, a, b) => Math.max(a, Math.min(b, v));

/* =========================
   Ø£ØµÙˆØ§Øª (Ø¨Ø¯ÙˆÙ† Ù…Ù„ÙØ§Øª) Ø¹Ø¨Ø± WebAudio
   ØªØ¹Ù…Ù„ Ø£ÙˆÙÙ„Ø§ÙŠÙ† ÙˆØªØ´ØªØºÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„ Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ Ù„Ù…Ø³Ø©
========================= */
const SFX = (() => {
  let ctxA = null;

  function ensure(){
    if(!ctxA){
      const AC = window.AudioContext || window.webkitAudioContext;
      if(!AC) return null;
      ctxA = new AC();
    }
    // ÙÙŠ iOS Ù‚Ø¯ ÙŠØ¨Ø¯Ø£ Ù…Ø¹Ù„Ù‚Ù‹Ø§ Ø­ØªÙ‰ Ø£ÙˆÙ„ ØªÙØ§Ø¹Ù„
    if(ctxA.state === "suspended") ctxA.resume().catch(()=>{});
    return ctxA;
  }

  function beep({type="sine", f=440, dur=0.10, gain=0.06, slide=null}={}){
    const ac = ensure();
    if(!ac) return;
    const o = ac.createOscillator();
    const g = ac.createGain();
    o.type = type;
    o.frequency.setValueAtTime(f, ac.currentTime);
    if(slide){
      o.frequency.exponentialRampToValueAtTime(Math.max(40, slide), ac.currentTime + dur);
    }
    g.gain.setValueAtTime(gain, ac.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime + dur);
    o.connect(g); g.connect(ac.destination);
    o.start();
    o.stop(ac.currentTime + dur);
  }

  function chord(){
    beep({type:"triangle", f:523, dur:0.08, gain:0.05});
    beep({type:"triangle", f:659, dur:0.10, gain:0.045});
    beep({type:"triangle", f:784, dur:0.12, gain:0.040});
  }

  return {
    unlock(){ ensure(); },              // Ù†Ø¯Ø§Ø¡ Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ù„Ù…Ø³
    jump(){ beep({type:"square", f:520, dur:0.08, gain:0.05, slide:820}); },
    web(){  beep({type:"sine",   f:880, dur:0.06, gain:0.04, slide:520}); },
    hit(){  beep({type:"sawtooth", f:180, dur:0.10, gain:0.06, slide:90}); },
    smash(){ beep({type:"sawtooth", f:260, dur:0.08, gain:0.07, slide:60}); },
    correct(){ chord(); },
    wrong(){ beep({type:"sawtooth", f:220, dur:0.22, gain:0.06, slide:70}); },
    levelup(){ beep({type:"triangle", f:440, dur:0.10, gain:0.05, slide:880}); beep({type:"triangle", f:660, dur:0.12, gain:0.045, slide:990}); }
  };
})();


/* =========================
   Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
========================= */
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

const hudName = document.getElementById("hudName");
const hudLevel = document.getElementById("hudLevel");
const hudScore = document.getElementById("hudScore");
const hudHits  = document.getElementById("hudHits");

const startOverlay = document.getElementById("startOverlay");
const btnStart = document.getElementById("btnStart");
const nameInput = document.getElementById("nameInput");

const qOverlay = document.getElementById("qOverlay");
const qText = document.getElementById("qText");
const qTimerEl = document.getElementById("qTimer");
const qChoices = document.getElementById("qChoices");
const qVisual = document.getElementById("qVisual");
const qNote = document.getElementById("qNote");
const btnRestart = document.getElementById("btnRestart");

const msgOverlay = document.getElementById("msgOverlay");

function hideAllOverlays(){
  startOverlay.style.display = "none";
  msgOverlay.style.display = "none";
  qOverlay.style.display = "none";
}

const msgTitle = document.getElementById("msgTitle");
const msgBody = document.getElementById("msgBody");
const btnContinue = document.getElementById("btnContinue");

let DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
let SCALE_X = DPR, SCALE_Y = DPR;

function resize(){
  const rect = canvas.getBoundingClientRect();
  const cssWidth  = rect.width;
  const cssHeight = rect.height;

  // Ø§Ø³ØªØ®Ø¯Ù… CEIL Ù„ØªØ¬Ù†Ø¨ Ù‚Øµ 1-2px Ø¨Ø³Ø¨Ø¨ Ø§Ù„ÙƒØ³ÙˆØ± ÙÙŠ iOS
  const backingW = Math.ceil(cssWidth * DPR);
  const backingH = Math.ceil(cssHeight * DPR);

  canvas.width  = backingW;
  canvas.height = backingH;

  canvas.style.width  = cssWidth + "px";
  canvas.style.height = cssHeight + "px";

  // Ù…Ù‚ÙŠØ§Ø³ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ (Ø¨Ø¯Ù„ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ DPR ÙÙ‚Ø·)
  SCALE_X = backingW / cssWidth;
  SCALE_Y = backingH / cssHeight;
}
window.addEventListener("resize", resize);
resize();

/* =========================
   Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
========================= */
const game = {
  running:false,
  asking:false,
  paused:false,
  playerName:"â€”",
  level:1,
  score:0,
  hits:0,             // 0..2 (Ø§Ù„Ø«Ø§Ù†ÙŠØ© ØªÙØ¸Ù‡Ø± Ø§Ù„Ø³Ø¤Ø§Ù„)
  graceActive:false,  // Ø´ÙØ§ÙÙŠØ© Ø¨Ø³ÙŠØ·Ø© Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ Ø§ØµØ·Ø¯Ø§Ù…
  time:0,
  lastT:0,
  spawnT:0,
  enemies:[],
  pits:[],
  pitSpawnT:0,
  particles:[],
  skylineSeed: 7,
  invulnT: 0,
  questionLock: false,
};

const player = {
  x: 180, y: 0,
  w: 52, h: 64,
  vy: 0,
  onGround:false,
  webActive:false,
  webT:0,
};

function resetAll(){
  game.level = 1;
  game.score = 0;
  game.hits = 0;
  game.graceActive = false;
  game.time = 0;
  game.spawnT = 0;
  game.enemies = [];
  game.pits = [];
  game.pitSpawnT = 0;
  game.particles = [];
  game.invulnT = 0;
  game.invulnT = 0;
  game.questionLock = false;
  safePlacePlayer();
  player.webActive = false;
  player.webT = 0;
  updateHud();
}

function updateHud(){
  hudName.textContent = game.playerName || "â€”";
  hudLevel.textContent = toArabicDigits(game.level);
  hudScore.textContent = toArabicDigits(game.score);
  hudHits.textContent  = toArabicDigits(game.hits);
}

function groundBaseline(){
  return canvas.height / SCALE_Y - 92;
}
function isPitAt(x){
  for(const p of game.pits){
    if(x >= p.x && x <= p.x + p.w) return true;
  }
  return false;
}
function groundYAt(x){
  return isPitAt(x) ? (canvas.height / SCALE_Y + 500) : groundBaseline();
}
function safePlacePlayer(){
  safePlacePlayer();
}

function difficulty(){
  // ÙƒÙ„ Ù…Ø±Ø­Ù„Ø© ØªØ²ÙŠØ¯ Ø§Ù„Ø³Ø±Ø¹Ø© ÙˆØªÙ‚Ù„Ù„ ÙˆÙ‚Øª ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡
  const speed = 240 + (game.level-1)*35;
  const spawnEvery = Math.max(0.65, 1.25 - (game.level-1)*0.06); // Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ
  return {speed, spawnEvery};
}

/* =========================
   Ø±Ø³Ù… Ø®Ù„ÙÙŠØ© Ù…Ø¨Ø§Ù†Ù Ø³Ø¹ÙˆØ¯ÙŠØ© (Ø³ØªØ§ÙŠÙ„ Ø¨Ø³ÙŠØ·)
========================= */
function drawSaudiSkyline(){
  const w = canvas.width / SCALE_X;
  const h = canvas.height / SCALE_Y;

  // Ø³Ù…Ø§Ø¡ Ù„ÙŠÙ„ÙŠØ©
  const sky = ctx.createLinearGradient(0,0,0,h);
  sky.addColorStop(0, "#14355f");
  sky.addColorStop(0.45, "#0c1b33");
  sky.addColorStop(1, "#070b14");
  ctx.fillStyle = sky;
  ctx.fillRect(0,0,w,h);

  // Ù‚Ù…Ø±
  if(showMoon){
  // Ù‚Ù…Ø± ÙˆØ§Ø¶Ø­
  ctx.save();
  ctx.globalAlpha = 0.9;
  ctx.fillStyle = "#e9eef7";
  ctx.beginPath();
  ctx.arc(w*0.82, h*0.16, 24, 0, Math.PI*2);
  ctx.fill();
  ctx.globalAlpha = 1;
  ctx.fillStyle = "#070b14";
  ctx.beginPath();
  ctx.arc(w*0.84, h*0.15, 22, 0, Math.PI*2);
  ctx.fill();
  ctx.restore();
  }

  // Ù†Ø¬ÙˆÙ… Ø¨Ø³ÙŠØ·Ø©
  if(showStars){
  ctx.save();
  ctx.fillStyle = "rgba(255,255,255,.9)";
  let r = game.skylineSeed;
  for(let i=0;i<90;i++){
    r = (r*9301 + 49297) % 233280;
    const x = (r/233280) * w;
    r = (r*9301 + 49297) % 233280;
    const y = (r/233280) * (h*0.40);
    ctx.fillRect(x, y, (i%11===0)?2:1, (i%11===0)?2:1);
  }
  ctx.restore();
  }

  // Ø·Ø¨Ù‚Ø§Øª Ù…Ø¨Ø§Ù†Ù "Ø·ÙŠÙ†ÙŠØ©/Ø­Ø¬Ø±ÙŠØ©" ÙˆØ§Ø¶Ø­Ø© (Ø¨Ø¯ÙˆÙ† Ø´ÙØ§ÙÙŠØ© Ø²Ø¬Ø§Ø¬ÙŠØ©)
  const layers = [
    {y: h*0.48, base:"#6d6a63", shadeNotice:"#5b5852", win:"#f2c97a", step:150, height:[110,230]},
    {y: h*0.58, base:"#8a7a60", shadeNotice:"#77674e", win:"#f5d189", step:120, height:[140,290]},
    {y: h*0.69, base:"#b79a73", shadeNotice:"#a1845f", win:"#ffd99a", step:95,  height:[170,340]},
  ];

  layers.forEach((L, li)=>{
    let x = -100;
    let seed = (game.skylineSeed+17) * (li+7);

    while(x < w+140){
      seed = (seed*1103515245 + 12345) >>> 0;
      const bw = L.step + (seed%90);
      seed = (seed*1103515245 + 12345) >>> 0;
      const bh = L.height[0] + (seed%(L.height[1]-L.height[0]));
      const y = L.y - bh;

      seed = (seed*1103515245 + 12345) >>> 0;
      const shapePick = seed % 12;

      // Ø¸Ù„ Ù„Ù„Ù…Ø¨Ù†Ù‰
      ctx.save();
      ctx.shadowColor = "rgba(0,0,0,0.35)";
      ctx.shadowBlur = 10;
      ctx.shadowOffsetY = 6;

      // Ø¬Ø³Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰
      ctx.fillStyle = L.base;
      if(shapePick < 8){
        ctx.fillRect(x, y, bw, bh);

        // Ø´Ø±ÙŠØ· Ø¸Ù„ Ø¬Ø§Ù†Ø¨ÙŠ
        ctx.fillStyle = L.shadeNotice;
        ctx.fillRect(x + bw*0.78, y, bw*0.22, bh);

        // Ø£Ø³Ù†Ø§Ù† Ø£Ø¹Ù„Ù‰ (Ù†Ø¬Ø¯ÙŠØ©)
        ctx.fillStyle = L.shadeNotice;
        const teeth = Math.max(5, Math.floor(bw/20));
        for(let t=0;t<teeth;t++){
          ctx.fillRect(x + t*(bw/teeth), y-8, 10, 8);
        }
      } else if(shapePick < 11){
        // Ø¨Ø±Ø¬
        const tw = bw*0.78;
        ctx.fillRect(x, y, tw, bh);
        ctx.fillStyle = L.shadeNotice;
        ctx.fillRect(x + tw*0.75, y, tw*0.25, bh);

        // Ø´Ø±ÙØ§Øª
        ctx.fillStyle = L.shadeNotice;
        ctx.fillRect(x+10, y+30, tw-20, 7);
        ctx.fillRect(x+10, y+60, tw-26, 7);
      } else {
        // Ù…Ø¦Ø°Ù†Ø© Ù…Ø¨Ø³Ø·Ø©
        const mw = Math.max(30, Math.floor(bw*0.34));
        const mx = x + Math.floor(bw*0.36);
        ctx.fillRect(mx, y+18, mw, bh-18);
        ctx.fillStyle = L.shadeNotice;
        ctx.fillRect(mx, y+10, mw, 10); // Ø´Ø±ÙØ©
        ctx.fillStyle = L.base;
        ctx.beginPath();
        ctx.arc(mx+mw/2, y+10, 12, Math.PI, 0);
        ctx.fill();
      }
      ctx.restore();

      // Ù†ÙˆØ§ÙØ° Ù‚Ù„ÙŠÙ„Ø© ÙˆÙˆØ§Ø¶Ø­Ø© (Ø¯Ø§ÙØ¦Ø©)
      ctx.save();
      ctx.fillStyle = L.win;
      const cols = Math.max(2, Math.floor(bw/34));
      const rows = Math.max(2, Math.floor(bh/44));
      for(let rr=0; rr<rows; rr++){
        for(let cc=0; cc<cols; cc++){
          seed = (seed*1103515245 + 12345) >>> 0;
          if((seed % 4) === 0) continue; // Ù„Ø§ ØªÙƒØ«Ø± Ù†ÙˆØ§ÙØ°
          const wx = x + 14 + cc*(bw-28)/cols;
          const wy = y + 22 + rr*(bh-40)/rows;
          // Ø£Ù‚ÙˆØ§Ø³ Ø¨Ø³ÙŠØ·Ø© Ù„Ø¨Ø¹Ø¶Ù‡Ø§ (Ø­Ø¬Ø§Ø²ÙŠ)
          if((seed % 6) === 0){
            ctx.beginPath();
            ctx.arc(wx+6, wy+7, 7, Math.PI, 0);
            ctx.closePath();
            ctx.fill();
            ctx.fillRect(wx-1, wy+7, 14, 12);
          } else {
            ctx.fillRect(wx, wy, 10, 14);
          }
        }
      }
      ctx.restore();

      // Ù…Ø¯Ø®Ù„ Ù‚ÙˆØ³ÙŠ Ø£Ø³ÙÙ„
      ctx.save();
      ctx.fillStyle = "rgba(0,0,0,.25)";
      const ax = x + bw*0.50;
      const ay = y + bh - 22;
      ctx.beginPath();
      ctx.arc(ax, ay, 16, Math.PI, 0);
      ctx.fill();
      ctx.fillRect(ax-16, ay, 32, 16);
      ctx.restore();

      x += bw - 24;
    }
  });

  // Ù†Ø®ÙŠÙ„ Ø£Ù…Ø§Ù…ÙŠ Ø¨Ø³ÙŠØ· Ù„Ø¥Ø­Ø³Ø§Ø³ Ø³Ø¹ÙˆØ¯ÙŠ
  ctx.save();
  const gy = groundBaseline();
  ctx.fillStyle = "#1b2a1e";
  for(let i=0;i<4;i++){
    const px = w*(0.15 + i*0.22);
    const ph = 90 + i*10;
    // Ø¬Ø°Ø¹
    ctx.fillRect(px-5, gy-ph, 10, ph);
    // Ø³Ø¹Ù
    ctx.fillStyle = "#243824";
    for(let k=0;k<6;k++){
      ctx.beginPath();
      ctx.ellipse(px, gy-ph, 28, 10, (k-2.5)*0.35, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.fillStyle = "#1b2a1e";
  }
  ctx.restore();

  // Ø£Ø±Ø¶ÙŠØ©
  ctx.fillStyle = "#070b14";
  ctx.fillRect(0, gy, w, h-gy);
  drawPits();

  // Ø®Ø· Ø£Ø±Ø¶ÙŠ
  ctx.strokeStyle = "rgba(255,255,255,.15)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(0, gy);
  ctx.lineTo(w, gy);
  ctx.stroke();
}

function drawPits(){
  const gy = groundBaseline();
  ctx.save();
  for(const p of game.pits){
    ctx.fillStyle = "rgba(0,0,0,.72)";
    ctx.fillRect(p.x, gy, p.w, (canvas.height / SCALE_Y) - gy);
    ctx.fillStyle = "rgba(255,255,255,.10)";
    ctx.fillRect(p.x-4, gy-6, 6, 12);
    ctx.fillRect(p.x + p.w-2, gy-6, 6, 12);
  }
  ctx.restore();
}

function roundRect(x,y,w,h,r){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
}

/* =========================
   Ø³Ø¨Ø§ÙŠØ¯Ø±Ù…Ø§Ù† + Ø®ÙŠØ·
========================= */
function drawSpiderman(){
  const x = player.x, y = player.y;

  ctx.save();
  ctx.globalAlpha = game.graceActive ? 0.55 : 1;

  // Ø±Ø£Ø³
  ctx.fillStyle = "#ff3b30";
  ctx.beginPath();
  ctx.ellipse(x+26, y+18, 18, 16, 0, 0, Math.PI*2);
  ctx.fill();

  // Ø´Ø¨ÙƒØ© Ø®ÙÙŠÙØ©
  ctx.save();
  ctx.globalAlpha *= 0.22;
  ctx.strokeStyle = "rgba(0,0,0,.85)";
  ctx.lineWidth = 1.2;
  for(let k=-12;k<=12;k+=6){
    ctx.beginPath();
    ctx.arc(x+26, y+18, 18, (k/18), Math.PI-(k/18));
    ctx.stroke();
  }
  ctx.restore();

  // Ø¹ÙŠÙˆÙ†
  ctx.fillStyle = "rgba(255,255,255,.96)";
  ctx.beginPath(); ctx.ellipse(x+18, y+18, 7, 5, -0.25, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(x+34, y+18, 7, 5,  0.25, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = "rgba(0,0,0,.35)";
  ctx.beginPath(); ctx.ellipse(x+18, y+18, 3, 2, -0.25, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(x+34, y+18, 3, 2,  0.25, 0, Math.PI*2); ctx.fill();

  // ØµØ¯Ø±
  ctx.fillStyle = "#1e3a8a";
  ctx.beginPath();
  ctx.roundRect(x+10, y+28, 32, 24, 10);
  ctx.fill();

  // Ø´Ø¹Ø§Ø± Ø¨Ø³ÙŠØ·
  ctx.save();
  ctx.globalAlpha *= 0.5;
  ctx.strokeStyle = "rgba(255,255,255,.9)";
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  ctx.moveTo(x+26, y+32); ctx.lineTo(x+26, y+50);
  ctx.moveTo(x+18, y+40); ctx.lineTo(x+34, y+40);
  ctx.stroke();
  ctx.restore();

  // Ø°Ø±Ø§Ø¹ÙŠÙ†
  ctx.fillStyle = "#ff3b30";
  ctx.beginPath(); ctx.roundRect(x+4, y+30, 10, 18, 6); ctx.fill();
  ctx.beginPath(); ctx.roundRect(x+38, y+30, 10, 18, 6); ctx.fill();

  // Ø±Ø¬Ù„ÙŠÙ†
  ctx.fillStyle = "#ff3b30";
  ctx.beginPath(); ctx.roundRect(x+14, y+52, 12, 14, 7); ctx.fill();
  ctx.beginPath(); ctx.roundRect(x+30, y+52, 12, 14, 7); ctx.fill();

  ctx.restore();

  // Ø®ÙŠØ· Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª
  if(player.webActive){
    ctx.save();
    ctx.strokeStyle = "rgba(255,255,255,.85)";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(x+26, y+22);
    ctx.lineTo(x+26, y-44);
    ctx.stroke();
    ctx.fillStyle = "rgba(255,255,255,.85)";
    ctx.beginPath();
    ctx.arc(x+26, y-44, 4, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
  }
}

/* =========================
   Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡
========================= */
function spawnPit(){
  const w = canvas.width / SCALE_X;
  const pitW = 70 + Math.random()*90 + Math.min(90, (game.level-1)*10);
  game.pits.push({ x: w + 40, w: pitW });
}

function spawnEnemy(){
  const w = canvas.width / SCALE_X;
  const gy = groundBaseline();

  const {speed} = difficulty();
  const e = {
    x: w + 40,
    y: gy - 44,
    w: 42,
    h: 44,
    vx: -speed,
    alive:true,
    kind: (Math.random()<0.25 ? "flyer" : (Math.random()<0.55 ? "walker" : "spiky"))
  };
  if(e.kind === "flyer"){
    e.w = 44; e.h = 30;
    e.y = gy - 140 - Math.random()*90;
    e.vx *= 1.10;
  } else if(e.kind === "spiky"){
    e.w = 40; e.h = 40;
    e.y = gy - e.h;
    e.vx *= 1.05;
  } else {
    e.w = 46; e.h = 50;
    e.y = gy - e.h;
  }
  game.enemies.push(e);
}

function drawEnemy(e){
  ctx.save();
  if(e.kind === "flyer"){
    ctx.globalAlpha = 0.95;
    ctx.fillStyle = "rgba(255,255,255,.16)";
    ctx.beginPath();
    ctx.ellipse(e.x+e.w/2, e.y+e.h/2, e.w/2, e.h/2, 0, 0, Math.PI*2);
    ctx.fill();

    ctx.save();
    ctx.globalAlpha = 0.55;
    ctx.strokeStyle = "rgba(255,255,255,.75)";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(e.x+6, e.y+e.h/2);
    ctx.quadraticCurveTo(e.x+e.w/2, e.y-10, e.x+e.w-6, e.y+e.h/2);
    ctx.stroke();
    ctx.restore();

    ctx.fillStyle = "rgba(0,0,0,.35)";
    ctx.beginPath();
    ctx.arc(e.x+e.w*0.62, e.y+e.h*0.52, 3, 0, Math.PI*2);
    ctx.fill();
  } else if(e.kind === "spiky"){
    ctx.globalAlpha = 0.95;
    ctx.fillStyle = "rgba(255,255,255,.14)";
    ctx.beginPath();
    ctx.roundRect(e.x, e.y, e.w, e.h, 14);
    ctx.fill();

    ctx.save();
    ctx.globalAlpha = 0.70;
    ctx.fillStyle = "rgba(255,59,48,.75)";
    for(let i=0;i<5;i++){
      const sx = e.x + 6 + i*7;
      ctx.beginPath();
      ctx.moveTo(sx, e.y+6);
      ctx.lineTo(sx+4, e.y-6);
      ctx.lineTo(sx+8, e.y+6);
      ctx.closePath();
      ctx.fill();
    }
    ctx.restore();

    ctx.fillStyle = "rgba(0,0,0,.35)";
    ctx.fillRect(e.x+10, e.y+18, e.w-20, 6);
  } else {
    ctx.globalAlpha = 0.95;
    ctx.fillStyle = "rgba(255,255,255,.14)";
    ctx.beginPath();
    ctx.roundRect(e.x, e.y, e.w, e.h, 16);
    ctx.fill();

    ctx.fillStyle = "rgba(255,255,255,.75)";
    ctx.beginPath(); ctx.arc(e.x+16, e.y+18, 4, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(e.x+e.w-16, e.y+18, 4, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = "rgba(0,0,0,.35)";
    ctx.beginPath(); ctx.arc(e.x+16, e.y+18, 2, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(e.x+e.w-16, e.y+18, 2, 0, Math.PI*2); ctx.fill();

    ctx.save();
    ctx.globalAlpha = 0.35;
    ctx.strokeStyle = "rgba(255,255,255,.65)";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(e.x+10, e.y+e.h-6); ctx.lineTo(e.x+18, e.y+e.h+8);
    ctx.moveTo(e.x+e.w-10, e.y+e.h-6); ctx.lineTo(e.x+e.w-18, e.y+e.h+8);
    ctx.stroke();
    ctx.restore();
  }
  ctx.restore();
}

function killEnemy(e){
  e.alive = false;
  game.score += 5;
  SFX.smash();
  game.camT = 0.18;
  for(let i=0;i<14;i++){
    game.particles.push({
      x: e.x + e.w/2,
      y: e.y + e.h/2,
      vx: (Math.random()*2-1)*160,
      vy: (Math.random()*2-1)*160,
      t: 0,
      life: 0.45 + Math.random()*0.25
    });
  }
}

/* =========================
   ØªØµØ§Ø¯Ù…
========================= */
function aabb(ax,ay,aw,ah,bx,by,bw,bh){
  return ax < bx+bw && ax+aw > bx && ay < by+bh && ay+ah > by;
}

function handleCollisions(dt){
  if(game.asking || game.paused) return;
  if(game.invulnT > 0) return;
  if(game.asking || game.questionLock) return;
  if(game.invulnT > 0) return;

  for(const e of game.enemies){
    if(!e.alive) continue;

    const hit = aabb(player.x, player.y, player.w, player.h, e.x, e.y, e.w, e.h);
    if(!hit) continue;

    const playerBottom = player.y + player.h;
    const enemyTop = e.y;
    const comingDown = player.vy > 60;
    const fromAbove = (playerBottom - enemyTop) < 18;

    if(comingDown && fromAbove){
      killEnemy(e);
      player.vy = -380;
      game.graceActive = false;
      game.hits = 0;
      updateHud();
      continue;
    }

    if(game.hits === 0){
      game.hits = 1;
      SFX.hit();
      game.graceActive = true;
      game.invulnT = 0.25;
      updateHud();
      player.x = Math.max(70, player.x - 12);
    } else {
      game.hits = 2;
      updateHud();
      startQuestion();
      return;
    }
  }
}

/* =========================
   Ø³Ø¤Ø§Ù„ (Ø¬Ù…Ø¹/Ø·Ø±Ø­ Ù -Ù¡Ù ) + Ù¢Ù  Ø«Ø§Ù†ÙŠØ©
========================= */
let qState = null;
let qInterval = null;

function randInt(a,b){ return Math.floor(a + Math.random()*(b-a+1)); }


function renderVisual(q){
  // ØªÙ…Ø«ÙŠÙ„ Ø¨ØµØ±ÙŠ Ù„Ù„Ø£Ø¹Ø¯Ø§Ø¯: Ù†Ù‚Ø§Ø· Ù„Ù„Ø¬Ù…Ø¹ØŒ ÙˆÙ†Ù‚Ø§Ø· Ù…Ø¹ Ø´Ø·Ø¨ Ù„Ù„Ù…Ø·Ø±ÙˆØ­ ÙÙŠ Ø§Ù„Ø·Ø±Ø­
  const makeTokens = (count, crossFromEnd=0) => {
    const wrap = document.createElement("div");
    wrap.className = "visualRow";
    for(let i=0;i<count;i++){
      const t = document.createElement("div");
      t.className = "token";
      if(crossFromEnd>0 && i >= count - crossFromEnd){
        t.className += " cross dim";
      }
      wrap.appendChild(t);
    }
    return wrap;
  };

  qVisual.innerHTML = "";
  if(q.op === "+"){
    const row1 = document.createElement("div");
    row1.className = "visualRow";
    const lab1 = document.createElement("div");
    lab1.className = "vLabel";
    lab1.textContent = `Ø§Ù„Ø¹Ø¯Ø¯ ${toArabicDigits(q.a)}:`;
    row1.appendChild(lab1);
    row1.appendChild(makeTokens(q.a));
    qVisual.appendChild(row1);

    const row2 = document.createElement("div");
    row2.className = "visualRow";
    row2.style.marginTop = "10px";
    const lab2 = document.createElement("div");
    lab2.className = "vLabel";
    lab2.textContent = `+ ${toArabicDigits(q.b)}:`;
    row2.appendChild(lab2);
    row2.appendChild(makeTokens(q.b));
    qVisual.appendChild(row2);

    const hint = document.createElement("div");
    hint.className = "visualHint";
    hint.textContent = "Ø§Ø¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ù†Ù‚Ø§Ø· ÙÙŠ Ø§Ù„Ø³Ø·Ø±ÙŠÙ† Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø§ØªØ¬.";
    qVisual.appendChild(hint);
  } else {
    const row1 = document.createElement("div");
    row1.className = "visualRow";
    const lab1 = document.createElement("div");
    lab1.className = "vLabel";
    lab1.textContent = `Ø§Ù„Ø¹Ø¯Ø¯ ${toArabicDigits(q.a)}:`;
    row1.appendChild(lab1);
    row1.appendChild(makeTokens(q.a, q.b));
    qVisual.appendChild(row1);

    const hint = document.createElement("div");
    hint.className = "visualHint";
    hint.textContent = `Ø§Ø´Ø·Ø¨ ${toArabicDigits(q.b)} Ù…Ù† Ù†Ù‚Ø§Ø· ${toArabicDigits(q.a)} Ù„ØªØ¹Ø±Ù Ø§Ù„Ù†Ø§ØªØ¬.`;
    qVisual.appendChild(hint);
  }
}


function makeQuestion(){
  const op = Math.random() < 0.5 ? "+" : "âˆ’";
  let a = randInt(0,10);
  let b = randInt(0,10);

  if(op === "âˆ’" && b > a){
    [a,b] = [b,a];
  }
  const answer = (op === "+") ? (a+b) : (a-b);

  const choices = new Set([answer]);
  while(choices.size < 4){
    let c = answer + randInt(-3,3);
    c = clamp(c, 0, 20);
    choices.add(c);
  }
  const arr = Array.from(choices);
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return {a,b,op,answer,choices:arr};
}

function startQuestion(){
  if(game.asking) return;
  game.questionLock = true;
  game.asking = true;
  game.running = false;
  game.graceActive = false;
  // Ù…Ù†Ø¹ Ø³Ù„Ø³Ù„Ø© Ø£Ø³Ø¦Ù„Ø©: Ù†Ø¸Ù‘Ù Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ† Ù„Ø£Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ ØºØ§Ù„Ø¨Ù‹Ø§ Ø¯Ø§Ø®Ù„Ù‡Ù…
  game.enemies = [];
  game.pits = [];
  game.pitSpawnT = 0;

  qOverlay.style.display = "flex";
  qNote.textContent = "Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‚Ø¨Ù„ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª.";
  qState = makeQuestion();

  renderVisual(qState);

  qText.textContent = `ÙƒÙ… Ù†Ø§ØªØ¬: ${toArabicDigits(qState.a)} ${qState.op} ${toArabicDigits(qState.b)} ØŸ`;
  qChoices.innerHTML = "";

  qState.choices.forEach(val=>{
    const div = document.createElement("div");
    div.className = "choice";
    div.textContent = toArabicDigits(val);
    div.addEventListener("click", ()=> submitAnswer(val), { once:true });
    qChoices.appendChild(div);
  });

  let t = 30;
  qTimerEl.textContent = toArabicDigits(t);
  clearInterval(qInterval);
  qInterval = setInterval(()=>{
    t--;
    qTimerEl.textContent = toArabicDigits(Math.max(0,t));
    if(t <= 0){
      clearInterval(qInterval);
      SFX.wrong();
      loseAndRestart("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª", "Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø¬Ø§Ø¨Ø© Ø®Ù„Ø§Ù„ Ù£Ù  Ø«Ø§Ù†ÙŠØ©. ØªØ¹ØªØ¨Ø± Ø®Ø§Ø³Ø± ÙˆØªØ¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯.");
    }
  }, 1000);
}

function submitAnswer(val){
  if(!qState) return;
  clearInterval(qInterval);

  if(val === qState.answer){
    qNote.textContent = "Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© âœ…";
    SFX.correct();
    game.score += 10;
    setTimeout(()=>{
      qOverlay.style.display = "none";
      game.asking = false;
      game.questionLock = false;
      qState = null;
      game.running = true;
      game.hits = 0;
      game.invulnT = 1.0; // Ø«Ø§Ù†ÙŠØ© Ø­Ù…Ø§ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø­ØªÙ‰ Ù„Ø§ ÙŠØªÙƒØ±Ø± Ø§Ù„Ø³Ø¤Ø§Ù„ ÙÙˆØ±Ø§Ù‹
      // Ù†Ø¸Ù Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡ Ø§Ù„Ù‚Ø±ÙŠØ¨ÙŠÙ† Ù„ØªØ¬Ù†Ø¨ Ø§ØµØ·Ø¯Ø§Ù… ÙÙˆØ±ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø©
      game.enemies = game.enemies.filter(e => e.x > player.x + 120);
      updateHud();
      safePlacePlayer();
  } else {
    player.onGround = false;
  }

  if(player.webActive){
    player.webT += dt;
    if(player.webT > 0.22){
      player.webActive = false;
    }
  }

  for(const e of game.enemies){
    e.x += e.vx * dt;
  }
  game.enemies = game.enemies.filter(e => e.x + e.w > -80 && e.alive);

  for(const p of game.pits){
    const {speed} = difficulty();
    p.x -= speed * dt;
  }
  game.pits = game.pits.filter(p => p.x + p.w > -120);

  for(const p of game.particles){
    p.t += dt;
    p.x += p.vx * dt;
    p.y += p.vy * dt;
    p.vx *= (1 - 3*dt);
    p.vy *= (1 - 3*dt);
  }
  game.particles = game.particles.filter(p => p.t < p.life);

  handleCollisions(dt);

  const target = 40 + (game.level-1)*35;
  if(game.score >= target){
    game.level++;
    SFX.levelup();
    game.camT = 0.22;
    game.score += 5;
  SFX.smash();
  game.camT = 0.18;
    updateHud();
    showMessage("Ù…Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© ğŸ‰", `Ø£Ø­Ø³Ù†Øª! ÙˆØµÙ„Øª Ù„Ù„Ù…Ø±Ø­Ù„Ø© ${toArabicDigits(game.level)}. Ø³ØªØ²Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø±Ø¹Ø© ÙˆØ§Ù„ØµØ¹ÙˆØ¨Ø©.`, false);
  }
}

function draw(){
  const w = canvas.width / SCALE_X;
  const h = canvas.height / SCALE_Y;

  ctx.setTransform(SCALE_X,0,0,SCALE_Y,0,0);
  ctx.translate(game.camX, game.camY);

  drawSaudiSkyline();

  for(const e of game.enemies) drawEnemy(e);

  for(const p of game.particles){
    const a = 1 - (p.t/p.life);
    ctx.save();
    ctx.globalAlpha = 0.55 * a;
    ctx.fillStyle = "rgba(255,255,255,.9)";
    ctx.beginPath();
    ctx.arc(p.x, p.y, 3, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
  }

  drawSpiderman();

  ctx.save();
  ctx.globalAlpha = 0.55;
  ctx.fillStyle = "rgba(255,255,255,.9)";
  ctx.font = "14px " + getComputedStyle(document.body).fontFamily;
  ctx.fillText("Ù„Ù„Ù‚ÙØ²: Ù„Ù…Ø³ Ø£Ùˆ Ù…Ø³Ø§ÙØ©", 14, 22);
  ctx.restore();
}

function loop(ts){
  const t = ts/1000;
  const dt = game.lastT ? clamp(t - game.lastT, 0, 0.033) : 0;
  game.lastT = t;

  if(!game.paused && !game.asking) update(dt);
  draw();

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* =========================
   ØªØ­ÙƒÙ…: Ù„Ù…Ø³/ÙƒÙŠØ¨ÙˆØ±Ø¯
========================= */
function jumpOrWeb(){
  if(!game.running) return;

  if(player.onGround){
    player.vy = -560;
    player.onGround = false;
    SFX.jump();
  } else {
    player.webActive = true;
    player.webT = 0;
    player.vy = Math.min(player.vy, 30);
    player.vy -= 260;
    SFX.web();
  }
}

window.addEventListener("keydown", (e)=>{
  if(e.code === "Space"){
    e.preventDefault();
    SFX.unlock();
    if(startOverlay.style.display !== "none") return;
    if(qOverlay.style.display !== "none") return;
    jumpOrWeb();
  }
});

canvas.addEventListener("pointerdown", (e)=>{
  e.preventDefault();
  SFX.unlock();
  if(startOverlay.style.display !== "none") return;
  if(qOverlay.style.display !== "none") return;
  jumpOrWeb();
});

/* =========================
   Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
========================= */
btnStart.addEventListener("click", () => {
  try{
    SFX.unlock();
    hideAllOverlays();
    resetAll();
    game.running = true;
  }catch(err){
    console.error(err);
    const box = document.getElementById('msgOverlay');
    const t = document.getElementById('msgTitle');
    const d = document.getElementById('msgDesc');
    if(box && t && d){
      box.classList.add('show');
      t.textContent = 'Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡';
      d.textContent = (err && err.message) ? err.message : String(err);
    } else {
      alert('Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡: ' + ((err && err.message) ? err.message : String(err)));
    }
  }
});

btnRestart.addEventListener("click", ()=>{
  qOverlay.style.display = "none";
  game.asking = false;
  game.questionLock = false;
  qState = null;
  resetAll();
  game.running = true;
});

/* =========================
   ØªØ³Ø¬ÙŠÙ„ Service Worker Ù„Ù„Ø£ÙˆÙÙ„Ø§ÙŠÙ†
========================= */
if("serviceWorker" in navigator){
  window.addEventListener("load", ()=>{
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  });
}
</script>

<script>
  // ÙØ­Øµ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª
  window.__BOOT_OK__ = true;
  document.addEventListener('DOMContentLoaded', () => {
    const b = document.getElementById('btnStart');
    if(b && b.textContent.trim() === 'Ø¨Ø¯Ø¡') b.textContent = 'Ø¨Ø¯Ø¡ âœ…';
  });
  // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø¯Ù„ Ù…Ø§ "ØªØ®ØªÙÙŠ"
  window.addEventListener('error', (e) => {
    try{
      const box = document.getElementById('msgOverlay');
      const t = document.getElementById('msgTitle');
      const d = document.getElementById('msgDesc');
      if(box && t && d){
        box.classList.add('show');
        t.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©';
        d.textContent = (e && e.message ? e.message : 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ') +
          (e && e.filename ? ('\n' + e.filename + ':' + e.lineno) : '');
      } else {
        alert('Ø®Ø·Ø£: ' + (e && e.message ? e.message : 'unknown'));
      }
    }catch(_){}
  });
</script>

</body>
</html>
